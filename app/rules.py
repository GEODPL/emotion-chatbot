def personal_reply(mood: int, sleep: str, water: str) -> str:
    reply = ""

    if mood < 30:
        reply += "Δύσκολη μέρα… σε καταλαβαίνω. "
    elif mood < 70:
        reply += "Φαίνεται πως η μέρα είχε πάνω-κάτω. "
    else:
        reply += "Χαίρομαι που σήμερα φαίνεται να είσαι σε σχετικά καλή διάθεση. "

    if sleep == "0–2":
        reply += "Ο πολύ λίγος ύπνος μπορεί να κάνει όλα τα συναισθήματα πιο έντονα. "
    elif sleep == "3–5":
        reply += "Δεν είναι κακό να υπάρχουν νύχτες με λίγο ύπνο, αλλά σε βάθος χρόνου σε κουράζει. "
    elif sleep == "6–8":
        reply += "Ο ύπνος σου φαίνεται σχετικά ισορροπημένος, που είναι καλή βάση. "
    else:
        reply += "Ο πολύς ύπνος μπορεί να είναι ανακουφιστικός, αλλά αξίζει να δούμε τι κρύβεται από πίσω. "

    if water == "0":
        reply += "Η έλλειψη νερού επηρεάζει το σώμα και το μυαλό, ίσως αξίζει να στοχεύσεις σε 1–2 ποτήρια αύριο. "
    elif water == "1–3":
        reply += "Η ενυδάτωσή σου είναι χαμηλή, αλλά είναι μια αρχή – μπορούμε να το βελτιώσουμε σταδιακά. "
    elif water == "4–6":
        reply += "Η ενυδάτωσή σου είναι σε καλό επίπεδο· το σώμα σου το εκτιμά. "
    else:
        reply += "Η πολύ καλή ενυδάτωση δείχνει ότι ήδη φροντίζεις τον εαυτό σου σε κάτι σημαντικό. "

    return reply


def fallback_therapeutic_reply(mood: int, sleep: str, water: str, user_text: str) -> str:
    txt = user_text.lower()
    parts: list[str] = []

    if mood < 30:
        parts.append(
            "Ακούγεται πως αυτή τη στιγμή κουβαλάς αρκετή συναισθηματική πίεση. "
            "Δεν είναι καθόλου εύκολο να νιώθεις έτσι και είναι σημαντικό που το αναγνωρίζεις."
        )
    elif mood < 70:
        parts.append(
            "Η μέρα σου φαίνεται να είχε και καλές και δύσκολες στιγμές, "
            "κάτι που μπορεί να είναι αρκετά κουραστικό ψυχικά."
        )
    else:
        parts.append(
            "Χαίρομαι που αυτή τη στιγμή νιώθεις σχετικά καλά· αξίζει να δούμε τι σε βοηθάει "
            "και πώς μπορείς να το κρατήσεις στη ζωή σου."
        )

    if "άγχ" in txt or "αγχος" in txt:
        parts.append(
            "Το άγχος συχνά συνδέεται με πολλές απαιτήσεις και προσδοκίες, από εσένα ή από τους άλλους."
        )

    if "πίεσ" in txt or "πιεζ" in txt:
        parts.append(
            "Η αίσθηση πίεσης συνδέεται συχνά με το ότι έχεις φορτωθεί περισσότερα απ’ όσα αντέχεις πραγματικά."
        )

    if "θλίψ" in txt or "στεναχ" in txt or "λύπη" in txt:
        parts.append(
            "Η θλίψη και η στεναχώρια συνήθως κρύβουν πίσω τους απογοητεύσεις ή απώλειες που δεν έχουν πάρει χώρο."
        )

    if "μοναξ" in txt:
        parts.append(
            "Η μοναξιά μπορεί να είναι έντονη ακόμη κι αν υπάρχουν άνθρωποι γύρω σου· "
            "έχει σημασία να δούμε πού νιώθεις περισσότερο μόνος/η."
        )

    if sleep in ["0–2", "3–5"]:
        parts.append(
            "Ο λίγος ύπνος ενισχύει την ευαισθησία του νευρικού συστήματος, "
            "οπότε όλα τα συναισθήματα μπορεί να βιώνονται πιο έντονα."
        )

    if water in ["0", "1–3"]:
        parts.append(
            "Η χαμηλή ενυδάτωση μπορεί επίσης να επηρεάζει ενέργεια, συγκέντρωση και διάθεση."
        )

    parts.append(
        "Αν νιώθεις άνετα, μπορείς να μου πεις ποιο θεωρείς ότι είναι το μεγαλύτερο βάρος "
        "που κουβαλάς αυτή τη στιγμή, ώστε να το δουλέψουμε μαζί βήμα-βήμα."
    )

    return " ".join(parts)


def exercise_suggestion(mood: int, sleep: str, water: str, user_text: str) -> str:
    txt = user_text.lower()

    if "άγχ" in txt or "αγχος" in txt or "φοβ" in txt:
        return (
            "🧘 Άσκηση αναπνοής 4–2–6:\n"
            "Εισπνοή από τη μύτη για 4'', κράτημα για 2'', εκπνοή από το στόμα για 6''. "
            "Επανάλαβε 5 φορές και παρατήρησε τι αλλάζει στο σώμα σου."
        )

    if "πίεσ" in txt or "πιεζ" in txt or "πολλά" in txt or "πολλα" in txt:
        return (
            "📌 Μικρή άσκηση αποφόρτισης:\n"
            "Γράψε μία πρόταση που αρχίζει με: «Αυτό που με βαραίνει περισσότερο είναι…» "
            "χωρίς να τη φιλτράρεις. Το πρώτο πράγμα που θα βγει, αξίζει προσοχής."
        )

    if "θλίψ" in txt or "στεναχ" in txt or "λύπη" in txt or "μοναξ" in txt:
        return (
            "🤍 Άσκηση ηρεμίας 20'':\n"
            "Βάλε το χέρι στο στήθος, πάρε μία αργή ανάσα και πες από μέσα σου: "
            "«Είναι εντάξει να νιώθω έτσι. Δεν είμαι ο/η μόνος/η που το περνάει.»"
        )

    if water == "0":
        return (
            "💧 Άσκηση φροντίδας:\n"
            "Αν μπορείς τώρα, πιες ένα ποτήρι νερό πριν συνεχίσουμε. Είναι μια μικρή αλλά ουσιαστική κίνηση προς τον εαυτό σου."
        )

    if sleep in ["0–2", "3–5"]:
        return (
            "😴 Μικρή άσκηση χαλάρωσης:\n"
            "Για 10 δευτερόλεπτα, χαλάρωσε συνειδητά τους ώμους και τη γνάθο σου, πάρε μία βαθιά ανάσα "
            "και άφησέ την αργά. Επανάλαβε 3 φορές."
        )

    if mood > 70:
        return (
            "🌿 Pocket journaling:\n"
            "Γράψε ένα πράγμα που πήγε καλά σήμερα, όσο μικρό κι αν είναι. "
            "Με τον καιρό ο εγκέφαλος μαθαίνει να εντοπίζει πιο εύκολα τα θετικά."
        )

    return (
        "📘 Μικρή άσκηση αναγνώρισης συναισθήματος:\n"
        "Αν έπρεπε να διαλέξεις μία λέξη για το πώς νιώθεις τώρα, ποια θα ήταν;"
    )


def is_emergency(text: str) -> bool:
    t = text.lower()
    red_flags = [
        "αυτοκτον",
        "να αυτοκτον",
        "να τελειώσω",
        "να τελειωσω",
        "δεν θέλω να ζω",
        "δεν θελω να ζω",
        "να βλάψω τον εαυτό μου",
        "να βλαψω τον εαυτο μου",
        "να χτυπήσω τον εαυτό μου",
        "να χτυπησω τον εαυτο μου",
        "δεν αντέχω άλλο",
        "δεν αντεχω αλλο",
        "να πεθάνω",
        "να πεθανω",
    ]
    return any(flag in t for flag in red_flags)


def emergency_message() -> str:
    return """
    <div class="emergency-card">
        <h4>⚠️ Αντιλαμβάνομαι ότι νιώθεις έντονη δυσφορία</h4>
        <p>Δεν μπορώ να προσφέρω βοήθεια σε καταστάσεις κρίσης, αλλά δεν είσαι μόνος/η.</p>
        <p><b>📞 Γραμμές άμεσης βοήθειας (Ελλάδα):</b><br>
        • <b>1018</b> – Γραμμή Παρέμβασης για την Αυτοκτονία (24/7)<br>
        • <b>112</b> – Ευρωπαϊκός αριθμός έκτακτης ανάγκης<br>
        • <b>10306</b> – Γραμμή Ψυχοκοινωνικής Υποστήριξης<br>
        • <b>1056</b> – «Χαμόγελο του Παιδιού» (για ανηλίκους)</p>
    </div>
    """


def targeted_question_from_profile(profile: dict, user_text: str) -> str | None:
    if not profile:
        return None

    main_issue = profile.get("main_issue", "").lower()
    role = profile.get("role", "").lower()
    focus = profile.get("focus", "").lower()

    base = "Με βάση όσα μου έχεις γράψει στο ιστορικό σου, θα ήθελα να σε ρωτήσω κάτι πιο συγκεκριμένο. "

    if "σπουδ" in main_issue or "σπουδ" in focus or "φοιτη" in role:
        return (
            base
            + "Ποιες είναι οι στιγμές που νιώθεις το μεγαλύτερο άγχος σε σχέση με τις σπουδές; "
              "Όταν διαβάζεις, όταν δίνεις εξετάσεις ή όταν σκέφτεσαι το μέλλον;"
        )

    if "αυτοεκτίμη" in main_issue or "αυτοπεπ" in main_issue or "αυτοεκτιμ" in focus:
        return (
            base
            + "Αν σκεφτείς την εικόνα που έχεις για τον εαυτό σου, ποια σκέψη νιώθεις ότι σε πληγώνει περισσότερο αυτή την περίοδο;"
        )

    if "οικογέν" in main_issue or "γονε" in focus:
        return (
            base
            + "Πώς θα περιέγραφες την ατμόσφαιρα στο σπίτι; Υπάρχει κάποια σχέση στην οικογένεια που σε δυσκολεύει περισσότερο;"
        )

    if "σχέσ" in main_issue or "σχεσ" in focus:
        return (
            base
            + "Όταν σκέφτεσαι τις σχέσεις σου με τους άλλους, τι σε δυσκολεύει περισσότερο: η εμπιστοσύνη, η απόρριψη, οι συγκρούσεις ή κάτι άλλο;"
        )

    if "διάθεση" in main_issue or "θλίψ" in main_issue or "κατάθλιψ" in focus:
        return (
            base
            + "Υπάρχουν στιγμές μέσα στη μέρα που νιώθεις ότι η διάθεσή σου πέφτει περισσότερο; Ποιες είναι αυτές;"
        )

    if focus:
        return (
            base
            + f"Αν σκεφτείς αυτό που ανέφερες ότι θα ήθελες να δουλέψουμε («{profile.get('focus','')}»), "
              "ποιο κομμάτι του νιώθεις ότι σε δυσκολεύει περισσότερο;"
        )

    return None
